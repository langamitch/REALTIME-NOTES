<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Dual-Device Notes</title>
    <style>
      /* --- Basic Styling --- */
      :root {
        --primary-color: black;
        --primary-hover: #0056b3;
        --danger-color: #d9534f;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --light-gray: #484848;
        --border-color: #000000;
        --background-color: #000000;
        --text-color: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: black;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        color: var(--text-color);
      }
      .container {
        background: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 700px;
        text-align: center;
      }
      .hidden {
        display: none !important;
      }
      h2,
      h3 {
        margin-top: 0;
      }
      h2{
        font-size: 16px;
        margin-bottom: 20px;
      }
      textarea,
      #viewer-content {
        width: 100%;
        background-color: #000000;
        color: #fafafa;
        height: 400px;
        box-sizing: border-box;
        font-size: 1rem;
        padding: 10px;
        border: 1px solid white;
        border-radius: 4px;
        resize: vertical;
      }
      #viewer-content {
        background: #fafafa;
        overflow-y: auto;
        white-space: pre-wrap; /* Respects newlines */
        text-align: left;
      }
      button {
        padding: 5px 15px;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 20px;
        border: 2px solid white;
        font-size: 13px;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: var(--primary-hover);
      }
      .role-prompt button {
        width: 120px;
        height: 120px;
        font-size: 1.2rem;
        margin: 10px;
      }
      #auth-screen input {
        display: block;
        background-color: #000000;
        width: calc(80% - 22px);
        padding: 8px;
        color: #ffffff;
        font-size: 16px;
        margin: 0 auto 10px auto;
        border: 2px solid white;
        border-radius: 4px;
      }
      #logout-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: var(--danger-color);
      }
      #status-bar {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        font-size: 0.9rem;
        color: #555;
        line-height: 1.4;
      }
      .connection-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: var(--success-color);
      }
      .status-connecting {
        background-color: var(--warning-color);
      }
      .status-disconnected {
        background-color: var(--danger-color);
      }
      .device-list {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        text-align: left;
      }
      .device-item {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .device-item:last-child {
        border-bottom: none;
      }
      .typer-indicator {
        color: var(--success-color);
        font-weight: bold;
      }
      .connection-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: var(--success-color);
      }
      .status-connecting {
        background-color: var(--warning-color);
      }
      .status-disconnected {
        background-color: var(--danger-color);
      }
      .device-list {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        text-align: left;
      }
      .device-item {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .device-item:last-child {
        border-bottom: none;
      }
      .typer-indicator {
        color: var(--success-color);
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="auth-screen">
        <h2>Dual-Device Notes Login</h2>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="login-btn">Login</button>
        <button id="signup-btn">Sign Up</button>
      </div>

      <div id="app-screen" class="hidden">
        <button id="logout-btn">Logout</button>
        <h2>Live Note</h2>

        <div id="role-prompt" class="hidden">
          <h3>Multiple Devices Detected!</h3>
          <p>Choose a role for this device.</p>
          <button id="typer-btn">Typer ‚úçÔ∏è</button>
          <button id="viewer-btn">Viewer üëÅÔ∏è</button>
        </div>

        <div id="typer-mode" class="hidden">
          <h3>Typer Mode</h3>
          <textarea
            id="note-editor"
            placeholder="Start typing... changes are saved and synced in real-time."
          ></textarea>
        </div>

        <div id="viewer-mode" class="hidden">
          <h3>Viewer Mode (Read-only)</h3>
          <div id="viewer-content">Waiting for content...</div>
        </div>

        <div id="status-bar">Connecting...</div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // =================================================================
      // üî• PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
      // =================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyC77ot4Lmu3q10fkNRSQTnTa_eSpTywloo",
        authDomain: "realtime-note-720c7.firebaseapp.com",
        projectId: "realtime-note-720c7",
        storageBucket: "realtime-note-720c7.firebasestorage.app",
        messagingSenderId: "904825696682",
        appId: "1:904825696682:web:e449475c3abfb2a95d3bd3",
        measurementId: "G-SJGKQSDQGL",
      };

      // =================================================================
      // üöÄ APP INITIALIZATION
      // =================================================================
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // --- Global State & Refs ---
      let currentUser = null;
      let activeDevicesListener = null;
      let noteListener = null;
      let deviceIP = null;
      let heartbeatInterval = null;
      const NOTE_ID = "shared_note"; // Using one shared note for this example

      // --- UI Elements ---
      const authScreen = document.getElementById("auth-screen");
      const appScreen = document.getElementById("app-screen");
      const rolePrompt = document.getElementById("role-prompt");
      const typerMode = document.getElementById("typer-mode");
      const viewerMode = document.getElementById("viewer-mode");
      const noteEditor = document.getElementById("note-editor");
      const viewerContent = document.getElementById("viewer-content");
      const statusBar = document.getElementById("status-bar");

      // =================================================================
      // üåê IP ADDRESS DETECTION
      // =================================================================
      async function getDeviceIP() {
        try {
          // Try to get IP from a public service
          const response = await fetch("https://api.ipify.org?format=json");
          const data = await response.json();
          return data.ip;
        } catch (error) {
          console.warn("Could not get public IP, using fallback:", error);
          // Fallback: generate a pseudo-IP based on timestamp and random number
          return `192.168.1.${Math.floor(Math.random() * 254) + 1}`;
        }
      }

      // =================================================================
      // üë§ AUTHENTICATION LOGIC
      // =================================================================
      document.getElementById("login-btn").addEventListener("click", () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!email || !password) {
          alert("Please enter both email and password");
          return;
        }
        auth
          .signInWithEmailAndPassword(email, password)
          .catch((error) => alert(error.message));
      });

      document.getElementById("signup-btn").addEventListener("click", () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!email || !password) {
          alert("Please enter both email and password");
          return;
        }
        auth
          .createUserWithEmailAndPassword(email, password)
          .catch((error) => alert(error.message));
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        auth.signOut();
      });

      // The main observer for auth state
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // User is signed in
          currentUser = user;
          authScreen.classList.add("hidden");
          appScreen.classList.remove("hidden");

          // Get device IP before registering
          deviceIP = await getDeviceIP();
          await registerDevice();
          listenForDeviceChanges();
          listenForNoteChanges();
          startHeartbeat();
        } else {
          // User is signed out
          await cleanup();
          currentUser = null;
          deviceIP = null;
          authScreen.classList.remove("hidden");
          appScreen.classList.add("hidden");
        }
      });

      // =================================================================
      // üíª DEVICE & SESSION MANAGEMENT
      // =================================================================
      async function registerDevice() {
        if (!currentUser || !deviceIP) return;
        const deviceRef = db
          .collection("users")
          .doc(currentUser.uid)
          .collection("activeDevices")
          .doc(deviceIP);
        try {
          await deviceRef.set({
            ipAddress: deviceIP,
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            role: "pending", // Role is 'pending' until assigned
            userAgent: navigator.userAgent,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch (error) {
          console.error("Error registering device:", error);
        }
      }

      function startHeartbeat() {
        // Send heartbeat every 30 seconds to keep device active
        heartbeatInterval = setInterval(async () => {
          if (currentUser && deviceIP) {
            const deviceRef = db
              .collection("users")
              .doc(currentUser.uid)
              .collection("activeDevices")
              .doc(deviceIP);
            await deviceRef
              .update({
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
              })
              .catch((err) => console.error("Heartbeat error:", err));
          }
        }, 30000);
      }

      function listenForDeviceChanges() {
        if (activeDevicesListener) activeDevicesListener(); // Unsubscribe from previous listener

        const devicesRef = db
          .collection("users")
          .doc(currentUser.uid)
          .collection("activeDevices");
        activeDevicesListener = devicesRef.onSnapshot(
          (snapshot) => {
            const devices = snapshot.docs.map((doc) => ({
              id: doc.id,
              ipAddress: doc.id,
              ...doc.data(),
            }));

            // Filter out devices that haven't been active in the last 2 minutes
            const now = Date.now();
            const activeDevices = devices.filter((device) => {
              const lastActive =
                device.lastActive?.toDate?.() ||
                new Date(device.timestamp?.toDate?.() || now);
              return now - lastActive.getTime() < 120000; // 2 minutes
            });

            const typer = activeDevices.find((d) => d.role === "typer");
            const thisDevice = activeDevices.find(
              (d) => d.ipAddress === deviceIP
            );

            updateStatusBar(activeDevices, typer);

            if (activeDevices.length > 1 && !typer) {
              showUI("prompt"); // Multiple devices, no typer yet -> show prompt
            } else if (typer && thisDevice?.ipAddress === typer.ipAddress) {
              showUI("typer"); // This device is the typer
            } else if (typer && thisDevice?.ipAddress !== typer.ipAddress) {
              showUI("viewer"); // Another device is the typer
            } else if (activeDevices.length === 1 && thisDevice) {
              setRole("typer"); // Only one device, becomes typer automatically
            }
          },
          (error) => {
            console.error("Error listening to device changes:", error);
          }
        );
      }

      async function setRole(role) {
        if (!currentUser || !deviceIP) return;
        const deviceRef = db
          .collection("users")
          .doc(currentUser.uid)
          .collection("activeDevices")
          .doc(deviceIP);
        await deviceRef.update({
          role: role,
          lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        });
      }

      document
        .getElementById("typer-btn")
        .addEventListener("click", () => setRole("typer"));
      document
        .getElementById("viewer-btn")
        .addEventListener("click", () => setRole("viewer"));

      function showUI(mode) {
        rolePrompt.classList.add("hidden");
        typerMode.classList.add("hidden");
        viewerMode.classList.add("hidden");

        if (mode === "prompt") rolePrompt.classList.remove("hidden");
        else if (mode === "typer") typerMode.classList.remove("hidden");
        else if (mode === "viewer") viewerMode.classList.remove("hidden");
      }

      function updateStatusBar(devices, typer) {
        let statusText = `<span class="connection-status status-connected"></span>`;
        statusText += `<b>Your IP:</b> ${deviceIP}<br>`;
        statusText += `<b>Connected Devices:</b> ${devices.length}<br>`;

        if (devices.length > 0) {
          statusText += `<div class="device-list">`;
          devices.forEach((device) => {
            const isTyper = typer && device.ipAddress === typer.ipAddress;
            const isThisDevice = device.ipAddress === deviceIP;
            statusText += `<div class="device-item">`;
            statusText += `<span>${device.ipAddress}</span>`;
            if (isThisDevice)
              statusText += ` <span style="color: var(--primary-color);">(You)</span>`;
            if (isTyper)
              statusText += ` <span class="typer-indicator">‚úçÔ∏è Typer</span>`;
            else if (device.role === "viewer")
              statusText += ` <span style="color: #666;">üëÅÔ∏è Viewer</span>`;
            statusText += `</div>`;
          });
          statusText += `</div>`;
        }

        if (typer) {
          const role =
            typer.ipAddress === deviceIP
              ? "You are the <b>Typer</b>"
              : "You are a <b>Viewer</b>";
          statusText += role;
        } else {
          statusText += "Waiting for a typer to be selected...";
        }
        statusBar.innerHTML = statusText;
      }

      // =================================================================
      // üìù NOTE SYNCING & CLEANUP
      // =================================================================
      let saveTimeout;

      // Typer: Save to Firestore after user stops typing for 1 second
      noteEditor.addEventListener("input", (e) => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          if (!currentUser) return;
          const noteRef = db
            .collection("users")
            .doc(currentUser.uid)
            .collection("notes")
            .doc(NOTE_ID);
          noteRef.set(
            {
              content: e.target.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: deviceIP,
            },
            { merge: true }
          ); // Use merge to avoid overwriting other fields
        }, 1000);
      });

      // Viewer/Typer: Listen for note changes from Firestore
      function listenForNoteChanges() {
        if (noteListener) noteListener(); // Unsubscribe

        const noteRef = db
          .collection("users")
          .doc(currentUser.uid)
          .collection("notes")
          .doc(NOTE_ID);
        noteListener = noteRef.onSnapshot(
          (doc) => {
            const content = doc.exists ? doc.data().content : "";
            // Update both views to keep them in sync regardless of role
            if (noteEditor.value !== content) {
              noteEditor.value = content;
            }
            viewerContent.textContent = content;
          },
          (error) => {
            console.error("Error listening to note changes:", error);
            viewerContent.textContent = "Error loading note.";
          }
        );
      }

      // Cleanup on logout or window close
      async function cleanup() {
        // Stop heartbeat
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }

        // Unsubscribe from listeners
        if (activeDevicesListener) activeDevicesListener();
        if (noteListener) noteListener();
        activeDevicesListener = null;
        noteListener = null;

        // Remove device from Firestore
        if (currentUser && deviceIP) {
          const deviceRef = db
            .collection("users")
            .doc(currentUser.uid)
            .collection("activeDevices")
            .doc(deviceIP);
          await deviceRef
            .delete()
            .catch((err) => console.error("Cleanup error:", err));
        }
      }

      window.addEventListener("beforeunload", (event) => {
        if (auth.currentUser) {
          cleanup();
        }
      });

      // Handle page visibility changes
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          // Page is hidden, stop heartbeat
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }
        } else {
          // Page is visible again, restart heartbeat
          if (currentUser && !heartbeatInterval) {
            startHeartbeat();
          }
        }
      });
    </script>
  </body>
</html>
